name: Package Unreal Engine Acher Of LegendProject
run-name: ${{ github.actor }} üöÄ UE5 Ìå®ÌÇ§Ïßï

on:
  workflow_dispatch: {}                # ÏàòÎèô Ïã§Ìñâ Î≤ÑÌäº
  push:
    branches: [ master ]               # Í∏∞Î≥∏ Î∏åÎûúÏπòÍ∞Ä mainÏù¥Î©¥ mainÏúºÎ°ú Î≥ÄÍ≤Ω
    paths-ignore:
      - 'Windows/**'
      - 'Build/**'
  pull_request:
    branches: [ master ]

jobs:
  build:
    runs-on: [self-hosted, Windows, X64]  # Îü¨ÎÑà ÎùºÎ≤®Í≥º Î∞òÎìúÏãú ÏùºÏπò
    defaults:
      run:
        shell: pwsh                      # PowerShellÎ°ú ÌÜµÏùº
    name: Package Unreal Engine Game

    steps:
      # 0) Îü∞ÌÉÄÏûÑ Ï†ïÎ≥¥
      - name: Echo runner info
        run: |
          echo "Runner OS: ${{ runner.os }}"
          echo "Ref: ${{ github.ref }}"
          echo "Repo: ${{ github.repository }}"
          $PSVersionTable.PSVersion
          whoami

      # 1) Git Í≤ΩÎ°ú Ï£ºÏûÖ (Checkout Ï†ÑÏóê!)
      - name: Add Git to PATH (bin & cmd)
        run: |
          $gitBin = 'C:\Program Files\Git\bin'
          $gitCmd = 'C:\Program Files\Git\cmd'
          if (Test-Path $gitBin) { echo $gitBin | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append }
          if (Test-Path $gitCmd) { echo $gitCmd | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append }
          where.exe git
          git --version

      # 2) ÎÑ§Ìä∏ÏõåÌÅ¨ Ï≤¥ÌÅ¨(ÏÑ†ÌÉù)
      - name: TLS test to github.com:443
        run: Test-NetConnection github.com -Port 443

      # 3) ÏΩîÎìú Ï≤¥ÌÅ¨ÏïÑÏõÉ
      - name: Checkout code
        uses: actions/checkout@v4

      # 4) Í≤ΩÎ°ú sanity Ï≤¥ÌÅ¨
      - name: "Sanity check - UE/UProject/Output dirs"
        run: |
          Write-Host "UAT:" (Test-Path 'D:\Epic Games\UE_5.4\Engine\Build\BatchFiles\RunUAT.bat')
          Write-Host "uproject:" (Test-Path 'E:\dohan\AcherOfLegend\AcherOfLegend\AcherOfLegend.uproject')
          New-Item -ItemType Directory -Force -Path 'E:\dohan\AcherOfLegend\AcherOfLegend\test\AcherOfLegend' | Out-Null

      # 5) Ìå®ÌÇ§Ïßï
      - name: Package Project (UAT BuildCookRun)
        env:
          UE_PATH: 'D:\Epic Games\UE_5.4'
          PROJECT_PATH: 'E:\dohan\AcherOfLegend\AcherOfLegend\AcherOfLegend.uproject'
          OUTPUT_PATH: 'E:\dohan\AcherOfLegend\AcherOfLegend\test\AcherOfLegend'
        run: >
          & "$env:UE_PATH\Engine\Build\BatchFiles\RunUAT.bat"
          BuildCookRun
          -project="$env:PROJECT_PATH"
          -noP4
          -platform=Win64
          -clientconfig=Development
          -serverconfig=Development
          -cook -allmaps -build -stage -pak -archive
          -archivedirectory="$env:OUTPUT_PATH"

      # 6) Windows Ìè¥Îçî ÏïïÏ∂ï
      - name: Compress Windows Folder
        run: |
          cd "E:\dohan\AcherOfLegend\AcherOfLegend\test"
          if (Test-Path "Windows.zip") { Remove-Item "Windows.zip" -Force }
          Compress-Archive -Path Windows -DestinationPath Windows.zip -Force
