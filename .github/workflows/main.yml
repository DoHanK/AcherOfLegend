name: Package Unreal Engine Acher Of LegendProject

on:
  workflow_dispatch: {}           # 수동 실행 버튼
  push:
    branches: [ master ]          # 실제 브랜치 이름 확인 필요
    paths-ignore:
      - 'Windows/**'
      - 'Build/**'
  pull_request:
    branches: [ master ]

jobs:
  build:
    runs-on: [self-hosted, Windows]
    defaults:
      run:
        shell: pwsh               # 모든 run 스텝을 PowerShell로 실행
    name: Package Unreal Engine Game
    steps:
      # 0. 러너 환경 디버그
      - name: Print PATH and where git
        run: |
          $env:PATH -split ';' | ForEach-Object { Write-Host $_ }
          where.exe git

      - name: Git version check
        run: git --version

      - name: TLS test to github.com:443
        run: |
          Test-NetConnection github.com -Port 443

      # 1. 코드 체크아웃
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. 경로 확인
      - name: "Sanity: check paths"
        run: |
          Test-Path 'D:\Epic Games\UE_5.4\Engine\Build\BatchFiles\RunUAT.bat'
          Test-Path 'E:\dohan\AcherOfLegend\AcherOfLegend\AcherOfLegend.uproject'
          New-Item -ItemType Directory -Force -Path 'E:\dohan\AcherOfLegend\AcherOfLegend\test\AcherOfLegend' | Out-Null

      # 3. Unreal Engine 프로젝트 패키징
      - name: Package Project
        env:
          UE_PATH: 'D:\Epic Games\UE_5.4'
          PROJECT_PATH: 'E:\dohan\AcherOfLegend\AcherOfLegend\AcherOfLegend.uproject'
          OUTPUT_PATH: 'E:\dohan\AcherOfLegend\AcherOfLegend\test\AcherOfLegend'
        run: >
          & "$env:UE_PATH\Engine\Build\BatchFiles\RunUAT.bat"
          BuildCookRun
          -project="$env:PROJECT_PATH"
          -noP4 -platform=Win64 -clientconfig=Development -serverconfig=Development
          -cook -allmaps -build -stage -pak -archive
          -archivedirectory="$env:OUTPUT_PATH"

      # 4. Windows 폴더 압축
      - name: Compress Windows Folder
        run: |
          cd "E:\dohan\AcherOfLegend\AcherOfLegend\test"
          if (Test-Path "Windows.zip") { Remove-Item "Windows.zip" -Force }
          Compress-Archive -Path Windows -DestinationPath Windows.zip -Force
