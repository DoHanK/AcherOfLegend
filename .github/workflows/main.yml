name: Package Unreal Engine AcherOfLegend Game Project

on:
  push:
    branches: [ master ]
    paths-ignore:
      - 'Windows/**'
      - 'Build/**'
  pull_request:
    branches: [ master ]

jobs:
  build:
    runs-on: self-hosted
    name: AcherOfLegend Game
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Package Project (UAT)
        shell: powershell
        env:
          UE_PATH: 'D:\Epic Games\UE_5.4'
          PROJECT_PATH: 'E:\dohan\AcherOfLegend\AcherOfLegend\AcherOfLegend.uproject'
          OUTPUT_PATH: 'E:\dohan\AcherOfLegend\AcherOfLegend\test'
        run: |
          $ErrorActionPreference = 'Stop'
          Set-ExecutionPolicy -Scope Process -ExecutionPolicy Bypass -Force

          # 경로 확인
          Write-Host "UE_PATH: $env:UE_PATH"
          Write-Host "PROJECT_PATH: $env:PROJECT_PATH"
          Write-Host "OUTPUT_PATH: $env:OUTPUT_PATH"

          if (-not (Test-Path "$env:UE_PATH\Engine\Build\BatchFiles\RunUAT.bat")) {
            throw "RunUAT.bat not found: $env:UE_PATH\Engine\Build\BatchFiles\RunUAT.bat"
          }
          if (-not (Test-Path $env:PROJECT_PATH)) {
            throw "uproject not found: $env:PROJECT_PATH"
          }
          if (-not (Test-Path $env:OUTPUT_PATH)) {
            New-Item -ItemType Directory -Path $env:OUTPUT_PATH | Out-Null
          }

          # UAT 실행 (줄바꿈은 PowerShell 백틱 사용, 끝에 공백 넣지 말 것)
          & "$env:UE_PATH\Engine\Build\BatchFiles\RunUAT.bat" BuildCookRun `
            -project="$env:PROJECT_PATH" `
            -noP4 -platform=Win64 `
            -clientconfig=Development `
            -cook -allmaps -build -stage -pak -archive `
            -archivedirectory="$env:OUTPUT_PATH" `
            -utf8output -unattended -NoLogTimes

      - name: Compress Windows Folder
        shell: powershell
        env:
          OUTPUT_PATH: 'E:\dohan\AcherOfLegend\AcherOfLegend\test'
        run: |
          $ErrorActionPreference = 'Stop'
          $winDir = Join-Path $env:OUTPUT_PATH 'Windows'
          $zipPath = Join-Path $env:OUTPUT_PATH 'Windows.zip'

          if (-not (Test-Path $winDir)) {
            throw "Windows package folder not found: $winDir"
          }
          if (Test-Path $zipPath) { Remove-Item $zipPath -Force }
          Compress-Archive -Path $winDir -DestinationPath $zipPath

      # 실패 시 로그 수집 (문제 추적 편하게)
      - name: Upload UAT Logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
              name: UAT-Logs
              path: |
                $ENV:USERPROFILE\AppData\Roaming\Unreal Engine\AutomationTool\Logs\**\*.log
                $ENV:LOCALAPPDATA\UnrealBuildTool\**\*.txt
                **\Saved\Logs\*.log
