name: Package Unreal Engine AcherOfLegend Game Project

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  workflow_dispatch: {}   # 수동 실행 버튼

jobs:
  build:
    runs-on: self-hosted
    name: AcherOfLegend Game
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Debug env & paths
        shell: powershell
        run: |
          $ErrorActionPreference = 'Stop'
          Write-Host "=== ExecutionPolicy(list) ==="
          Get-ExecutionPolicy -List | Format-Table -AutoSize | Out-String | Write-Host
          Write-Host "=== Env ==="
          Write-Host "UE_PATH= D:\Epic Games\UE_5.4"
          Write-Host "PROJECT_PATH= E:\dohan\AcherOfLegend\AcherOfLegend\AcherOfLegend.uproject"
          Write-Host "OUTPUT_PATH= E:\dohan\AcherOfLegend\AcherOfLegend\test"

          $ue   = 'D:\Epic Games\UE_5.4'
          $proj = 'E:\dohan\AcherOfLegend\AcherOfLegend\AcherOfLegend.uproject'
          $out  = 'E:\dohan\AcherOfLegend\AcherOfLegend\test'

          Write-Host "UE exists? " (Test-Path $ue)
          Write-Host "UAT exists? " (Test-Path (Join-Path $ue 'Engine\Build\BatchFiles\RunUAT.bat'))
          Write-Host "uproject exists? " (Test-Path $proj)
          if (-not (Test-Path $out)) { New-Item -ItemType Directory -Path $out | Out-Null }
          Write-Host "OUTPUT exists? " (Test-Path $out)

      - name: Package Project (UAT)
        shell: powershell
        env:
          UE_PATH: 'D:\Epic Games\UE_5.4'
          PROJECT_PATH: 'E:\dohan\AcherOfLegend\AcherOfLegend\AcherOfLegend.uproject'
          OUTPUT_PATH: 'E:\dohan\AcherOfLegend\AcherOfLegend\test'
        run: |
          $ErrorActionPreference = 'Stop'
          Set-ExecutionPolicy -Scope Process -ExecutionPolicy Bypass -Force

          $uat = Join-Path $env:UE_PATH 'Engine\Build\BatchFiles\RunUAT.bat'
          if (-not (Test-Path $uat)) { throw "RunUAT.bat not found: $uat" }
          if (-not (Test-Path $env:PROJECT_PATH)) { throw "uproject not found: $env:PROJECT_PATH" }
          if (-not (Test-Path $env:OUTPUT_PATH)) { New-Item -ItemType Directory -Path $env:OUTPUT_PATH | Out-Null }

          Write-Host "=== Running UAT ==="
          & "$uat" BuildCookRun `
            -project="$env:PROJECT_PATH" `
            -noP4 -platform=Win64 `
            -clientconfig=Development `
            -cook -allmaps -build -stage -pak -archive `
            -archivedirectory="$env:OUTPUT_PATH" `
            -utf8output -unattended -NoLogTimes

          $code = $LASTEXITCODE
          Write-Host "UAT exit code: $code"
          if ($code -ne 0) { throw "UAT failed with exit code $code" }

      - name: Compress Windows Folder
        shell: powershell
        env:
          OUTPUT_PATH: 'E:\dohan\AcherOfLegend\AcherOfLegend\test'
        run: |
          $ErrorActionPreference = 'Stop'
          $winDir = Join-Path $env:OUTPUT_PATH 'Windows'
          if (-not (Test-Path $winDir)) { throw "Windows package folder not found: $winDir" }
          $zipPath = Join-Path $env:OUTPUT_PATH 'Windows.zip'
          if (Test-Path $zipPath) { Remove-Item $zipPath -Force }
          Compress-Archive -Path $winDir -DestinationPath $zipPath

      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: UAT-Logs
          path: |
            $ENV:USERPROFILE\AppData\Roaming\Unreal Engine\AutomationTool\Logs\**\*.log
            $ENV:LOCALAPPDATA\UnrealBuildTool\**\*.txt
            **\Saved\Logs\*.log
