name: Package Unreal Engine AcherOfLegend Game Project

on:
  push:
    branches: [ master ]         # 필요하면 main 추가: [ master, main ]
  pull_request:
    branches: [ master ]
  workflow_dispatch: {}          # 수동 실행 버튼

jobs:
  build:
    runs-on: [ self-hosted, Windows, X64 ]   # 러너 라벨과 반드시 일치해야 함
    name: AcherOfLegend Game

    steps:
      # 0) 리포 체크아웃
      - name: Checkout
        uses: actions/checkout@v4

      # 1) 러너/환경 기본 확인 (스텝이 실제로 실행되는지 확인)
      - name: Sanity - runner info
        shell: powershell
        run: |
          $ErrorActionPreference='Stop'
          Write-Host "RUNNER_OS=$env:RUNNER_OS"
          Write-Host "RUNNER_ARCH=$env:RUNNER_ARCH"
          Write-Host "RUNNER_NAME=$env:RUNNER_NAME"
          Start-Sleep -Seconds 5
          Write-Host "Runner step OK."

      # 2) 경로/정책 진단
      - name: Debug env & paths
        shell: powershell
        env:
          UE_PATH: 'D:\Epic Games\UE_5.4'
          PROJECT_PATH: 'E:\dohan\AcherOfLegend\AcherOfLegend\AcherOfLegend.uproject'
          OUTPUT_PATH: 'E:\dohan\AcherOfLegend\AcherOfLegend\Builds'   # 원하는 출력 폴더
        run: |
          $ErrorActionPreference='Stop'
          Write-Host "=== ExecutionPolicy (List) ==="
          Get-ExecutionPolicy -List | Format-Table -AutoSize | Out-String | Write-Host

          Write-Host "=== Paths ==="
          Write-Host "UE_PATH      : $env:UE_PATH"
          Write-Host "PROJECT_PATH : $env:PROJECT_PATH"
          Write-Host "OUTPUT_PATH  : $env:OUTPUT_PATH"

          $uat = Join-Path $env:UE_PATH 'Engine\Build\BatchFiles\RunUAT.bat'
          Write-Host "UE exists?        " (Test-Path $env:UE_PATH)
          Write-Host "UAT exists?       " (Test-Path $uat)
          Write-Host "uproject exists?  " (Test-Path $env:PROJECT_PATH)
          if (-not (Test-Path $env:OUTPUT_PATH)) { New-Item -ItemType Directory -Path $env:OUTPUT_PATH | Out-Null }
          Write-Host "OUTPUT exists?    " (Test-Path $env:OUTPUT_PATH)

      # 3) 패키징 (UAT)
      - name: Package Project (UAT)
        shell: powershell
        env:
          UE_PATH: 'D:\Epic Games\UE_5.4'
          PROJECT_PATH: 'E:\dohan\AcherOfLegend\AcherOfLegend\AcherOfLegend.uproject'
          OUTPUT_PATH: 'E:\dohan\AcherOfLegend\AcherOfLegend\Builds'
        run: |
          $ErrorActionPreference='Stop'
          # 세션 내 실행정책 우회 (서비스/그룹정책 영향 방지)
          Set-ExecutionPolicy -Scope Process -ExecutionPolicy Bypass -Force

          $uat = Join-Path $env:UE_PATH 'Engine\Build\BatchFiles\RunUAT.bat'
          if (-not (Test-Path $uat)) { throw "RunUAT.bat not found: $uat" }
          if (-not (Test-Path $env:PROJECT_PATH)) { throw "uproject not found: $env:PROJECT_PATH" }
          if (-not (Test-Path $env:OUTPUT_PATH)) { New-Item -ItemType Directory -Path $env:OUTPUT_PATH | Out-Null }

          Write-Host "=== Running UAT BuildCookRun ==="
          & "$uat" BuildCookRun `
            -project="$env:PROJECT_PATH" `
            -noP4 -platform=Win64 `
            -clientconfig=Development `
            -cook -allmaps -build -stage -pak -archive `
            -archivedirectory="$env:OUTPUT_PATH" `
            -utf8output -unattended -NoLogTimes

          $c
